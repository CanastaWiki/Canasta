name: Docker build and push

# limit concurrency
# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#examples-using-concurrency-and-the-default-behavior
concurrency: docker_canasta_main

on:
  push:
    # Only activate for `master` branch
    branches:
      - master
      - 1.2.x
    # Plus for all tags
    tags:
      - '*'

  # Plus for any pull-requests
  pull_request:

  # Manual trigger (e.g., after CanastaBase is rebuilt)
  workflow_dispatch:

env:
  IMAGE_NAME: canasta

jobs:
  # Test the image Dockerfile syntax using https://github.com/replicatedhq/dockerfilelint
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v3

  # Push image to GitHub Packages.
  # The image tag pattern is:
  # for pull-requests: <MW_VERSION>-<DATE>-<PR_NUMBER>, eg: 1.43.1-20260224-25
  # for git tags: <TAG> (with "v" prefix stripped, e.g., v3.2.0 → 3.2.0)
  # for `master` branch: latest + <MW_MAJOR>-latest + <MW_VERSION>-latest + <MW_VERSION>-<DATE>-<SHA>
  push:
    needs: [test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      -
        name: Extract MW_VERSION from CanastaBase labels
        id: extract_mw
        run: |
          set -euo pipefail
          BASE_IMAGE=$(awk -F'=' '/^ARG BASE_IMAGE=/ {print $2}' Dockerfile)
          # Parse registry, image path, and tag from BASE_IMAGE
          REGISTRY=$(echo "$BASE_IMAGE" | cut -d/ -f1)
          IMAGE_PATH=$(echo "$BASE_IMAGE" | cut -d/ -f2- | cut -d: -f1)
          TAG=$(echo "$BASE_IMAGE" | grep -o ':[^:]*$' | tr -d ':')
          TAG=${TAG:-latest}
          # Get anonymous bearer token
          TOKEN=$(curl -s "https://$REGISTRY/token?scope=repository:${IMAGE_PATH}:pull" | jq -r .token)
          # Fetch OCI image index and pick the amd64/linux manifest digest
          MANIFEST_DIGEST=$(curl -s \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.oci.image.index.v1+json" \
            "https://$REGISTRY/v2/${IMAGE_PATH}/manifests/$TAG" \
            | jq -r '.manifests[] | select(.platform.architecture=="amd64" and .platform.os=="linux") | .digest')
          # Fetch the platform manifest to get the config blob digest
          CONFIG_DIGEST=$(curl -s \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.oci.image.manifest.v1+json" \
            "https://$REGISTRY/v2/${IMAGE_PATH}/manifests/$MANIFEST_DIGEST" \
            | jq -r '.config.digest')
          # Fetch the config blob (a few KB) and extract the label
          MW_VERSION=$(curl -sL \
            -H "Authorization: Bearer $TOKEN" \
            "https://$REGISTRY/v2/${IMAGE_PATH}/blobs/$CONFIG_DIGEST" \
            | jq -r '.config.Labels["wiki.canasta.mediawiki.version"]')
          echo "MW_VERSION=$MW_VERSION"
          echo "MW_VERSION=$MW_VERSION" >> $GITHUB_ENV

      -
        name: Generate tags
        id: generate
        run: |

          # Image ID
          IMAGE_ID=ghcr.io/canastawiki/$IMAGE_NAME

          # Date
          BDATE=$(date +%Y%m%d)

          MEDIAWIKI_VERSION=${{ env.MW_VERSION }}
          # Extract MW major version (like 1.43)
          MEDIAWIKI_MAJOR_VERSION=${MEDIAWIKI_VERSION%.*}

          # Change all uppercase to lowercase, just in case
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')

          # Strip git ref prefix from version and use it as suffix for version
          VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')

          # Get the Canasta version from the "VERSION" file
          CANASTA_VERSION=$(cat VERSION)

          # For pull requests just extract the PR number
          PR_NUMBER=""
          [ "${{ github.event_name }}" == "pull_request" ] && VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\)/merge,\1,')
          [ "${{ github.event_name }}" == "pull_request" ] && PR_NUMBER=$VERSION

          # Append version
          [ "${{ github.event_name }}" == "pull_request" ] && VERSION=$MEDIAWIKI_VERSION-$BDATE-$VERSION

          # Strip "v" prefix from tag name (e.g., v3.2.0 → 3.2.0)
          [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')

          # Use Docker `latest` tag convention if it's a master branch build
          [ "$VERSION" == "master" ] && VERSION=latest

          # Compose REGISTRY_TAGS variable
          REGISTRY_TAGS=$IMAGE_ID:$VERSION

          # For master branch also supply extra tags: <MW_MAJOR>-latest, <MW_VERSION>-latest, <MW_VERSION>-<DATE>-<SHA>
          # Note: $CANASTA_VERSION (e.g., 3.2.0) is NOT included here — it is only
          # published when a Git tag is pushed, making it an immutable release tag.
          [ "$VERSION" == "latest" ] && REGISTRY_TAGS=$REGISTRY_TAGS,$IMAGE_ID:$MEDIAWIKI_MAJOR_VERSION-latest,$IMAGE_ID:$MEDIAWIKI_VERSION-latest,$IMAGE_ID:$MEDIAWIKI_VERSION-$BDATE-$(git rev-parse --short HEAD)

          echo IMAGE_ID=$IMAGE_ID
          echo VERSION=$VERSION
          echo REGISTRY_TAGS=$REGISTRY_TAGS
          echo headref=${{ github.head_ref }}

          SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-8)
          [ "${{ github.event_name }}" == "pull_request" ] && SHA_SHORT=$(echo ${{ github.event.pull_request.head.sha }} | cut -c1-8)

          echo "Final image tag to be pushed:"
          echo $REGISTRY_TAGS
          echo "REGISTRY_TAGS=$REGISTRY_TAGS" >> $GITHUB_OUTPUT
          echo "REGISTRY_TAGS_VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "REGISTRY_TAGS_PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "SHA_SHORT=$SHA_SHORT" >> $GITHUB_OUTPUT
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v1
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          install: true
      -
        name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      -
        name: Build and push
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64, linux/arm64
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ${{ steps.generate.outputs.REGISTRY_TAGS }}
      -
        name: Image digest
        run: echo ${{ steps.docker_build.outputs.digest }}
      -
        name: Image tags debug
        run: echo ${{ steps.generate.outputs.REGISTRY_TAGS }}

      -
        name: Notify about image tag
        if: github.event_name == 'pull_request' && steps.docker_build.outputs.digest != ''
        uses: hasura/comment-progress@v2.2.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          number: ${{ github.event.number }}
          id: comment
          message: ":whale: The image based on [${{ steps.generate.outputs.SHA_SHORT }}](https://github.com/CanastaWiki/Canasta/pull/${{ steps.generate.outputs.REGISTRY_TAGS_PR_NUMBER }}/commits/${{ github.event.pull_request.head.sha }}) commit has been built with `${{ steps.generate.outputs.REGISTRY_TAGS_VERSION }}` tag as [${{ steps.generate.outputs.REGISTRY_TAGS }}](https://github.com/${{ github.repository }}/pkgs/container/${{ env.IMAGE_NAME }}/${{ steps.docker_build.outputs.imageid }}?tag=${{ steps.generate.outputs.REGISTRY_TAGS_VERSION }})"
          recreate: true
          fail: false

  # Auto-tag when the VERSION file changes on master.
  # This triggers a new workflow run for the tag event, which builds and
  # publishes the immutable versioned Docker image tag (e.g., 3.2.1).
  auto-tag:
    needs: [push]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Create Git tag from VERSION if it does not exist
        run: |
          VERSION=$(cat VERSION)
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists, skipping."
          else
            echo "Creating tag v$VERSION"
            git tag "v$VERSION"
            git push origin "v$VERSION"
          fi
